# Sprint 12 - wfpsim Integration & Feature Development

> **Status**: Phase 1 Complete
> **Target**: January-February 2026
> **Starting Test Count**: 1,102 tests
> **Current Test Count**: 1,169+ tests (67 new wfpsim tests)

---

## Overview

Sprint 12 focuses on integrating with the wfpsim combat simulator for team DPS analysis, plus completing deferred items from Sprint 11.

### Key Decision: wfpsim Integration over Custom DPS Calculator

After evaluating options for Team DPS Comparison (Sprint 11 Phase 3.1), we decided to integrate with the existing [wfpsim](https://wfpsim.com/) tool rather than building a custom DPS calculator.

**Rationale:**
- wfpsim is a mature Monte Carlo combat simulator (fork of gcsim)
- Actively maintained through patch 6.3+ (v6.3.5 released Dec 2025)
- Building accurate DPS calculations would require ~40k+ lines and ongoing maintenance
- Integration provides better accuracy with lower development/maintenance cost

**Trade-offs:**
- Users need to add rotation scripts manually in wfpsim
- Requires context switch to wfpsim.com (or future embedded binary)

---

## Phase 1: wfpsim Export Integration ✅ COMPLETE

**Goal**: Allow users to export team configurations to wfpsim-compatible format.

### 1.1 gcsim Key Mappings ✅

Created comprehensive mapping files to convert our data format to gcsim/wfpsim format.

| Mapping | Description | Entries |
|---------|-------------|---------|
| Characters | `"Raiden Shogun"` → `"raiden"` | 100+ |
| Weapons | `"The Catch"` → `"thecatch"` | 150+ |
| Artifact Sets | `"Emblem of Severed Fate"` → `"emblem"` | 40+ |
| Stats | `"critRate_"` → `"cr"` | 25 |

**File**: `src/features/teams/domain/gcsimKeyMappings.ts` (~670 lines)

**Key Functions:**
- `toGcsimCharacterKey()` - handles special cases (Raiden Shogun, Hu Tao, Traveler variants)
- `toGcsimWeaponKey()` - unique key per weapon (favoniussword, favoniuslance, etc.)
- `toGcsimArtifactSetKey()` - set name conversions
- `toGcsimStatKey()` / `toGcsimStatValue()` - stat conversions with percentage handling
- `getArtifactSetConfig()` - determines 4pc or 2pc+2pc configurations
- `countArtifactSets()` - counts artifact set pieces

### 1.2 Config Generator Service ✅

**File**: `src/features/teams/domain/gcsimConfigGenerator.ts` (~410 lines)

**Functions:**
- `generateGcsimConfig(team, characters, options)` - main export function
- `validateTeamForExport(team, characters)` - validation with error messages
- `generateConfigPreview(team, characters, maxLines)` - truncated preview

**Generated Config Example:**
```
# Team: National Team
# Generated by Genshin Progress Tracker
# 2026-01-12

options iteration=1000 duration=90 swap_delay=4;
target lvl=100 resist=0.1;

# Raiden
raiden char lvl=90/90 cons=0 talent=1,9,9;
raiden add weapon="thecatch" refine=5 lvl=90/90;
raiden add set="emblem" count=4;
raiden add stats hp=4780 atk=358 er=0.5180 cr=0.3110 cd=0.6220;

active raiden;

# TODO: Add rotation
# Example rotation:
# raiden skill, burst;
```

### 1.3 Export UI ✅

**File**: `src/features/teams/components/WfpsimExportModal.tsx` (~220 lines)

**Features:**
- Config preview with syntax highlighting
- Adjustable options (iterations, duration, target level, resistance)
- Include/exclude comments toggle
- Copy to clipboard with visual feedback
- Open wfpsim.com button
- Validation warnings for incomplete data
- Step-by-step instructions with docs links

**Integration:**
- Zap icon button added to TeamCard component
- Modal state managed in useRosterModals hook
- Wired through TeamSection → RosterPage

### 1.4 Tests ✅

| Test File | Tests |
|-----------|-------|
| `gcsimKeyMappings.test.ts` | 32 |
| `gcsimConfigGenerator.test.ts` | 20 |
| `WfpsimExportModal.test.tsx` | 15 |
| **Total** | **67** |

**Phase 1 Actual:** ~1,300 lines code, 67 tests

---

## Phase 2: Deferred Sprint 11 Items

### 2.1 E2E Test Suite

Create end-to-end tests for critical user workflows using Playwright.

| Workflow | Description | Priority |
|----------|-------------|----------|
| Wish Import Flow | Import URL → Parse → View Statistics | Critical |
| Character Planning | Add Character → Set Goals → View Materials | Critical |
| Team Management | Create Team → Add Characters → Export to wfpsim | High |
| Data Export/Import | Export GOOD → Clear → Import → Verify | Medium |

### 2.2 Cross-Feature Coupling Reduction

Reduce tight coupling in `resourceService.ts` using dependency injection.

---

## Phase 3: Additional Features (Stretch)

### 3.1 Build Templates

Save, load, and share character build configurations.

### 3.2 Weekly Boss Tracker

Track weekly boss completions with reset timer.

### 3.3 Future: Embedded wfpsim Binary

If export workflow proves popular, consider bundling wfpsim binary with Tauri app for seamless in-app simulation.

**Requirements:**
- Download platform-specific binaries (Win/Mac/Linux)
- Call from Rust backend via `std::process::Command`
- Parse JSON output and display in UI
- Track wfpsim releases for updates

**Estimated effort:** 1,000-1,500 lines, significant testing

---

## Data Model Reference

### Existing Types (no changes needed)

**Team:**
```typescript
interface Team {
  id: string;
  name: string;
  characterKeys: string[];  // Ordered by rotation
  rotationNotes: string;
  tags: string[];
  createdAt: string;
  updatedAt: string;
}
```

**Character:**
```typescript
interface Character {
  id: string;
  key: string;
  level: number;
  ascension: number;
  constellation: number;
  talent: { auto: number; skill: number; burst: number };
  weapon: Weapon;
  artifacts: Artifact[];
  // ...
}
```

**Weapon:**
```typescript
interface Weapon {
  key: string;
  level: number;
  ascension: number;
  refinement: number;
}
```

**Artifact:**
```typescript
interface Artifact {
  setKey: string;
  slotKey: SlotKey;
  level: number;
  rarity: number;
  mainStatKey: string;
  substats: Substat[];
}
```

---

## Sprint 12 Deliverables

### Must Have
- [x] gcsim key mappings (characters, weapons, artifacts, stats)
- [x] Config generator service with tests
- [x] Export UI modal on team cards
- [x] Documentation for users

### Should Have
- [ ] E2E test suite (3+ critical workflows)
- [ ] Cross-feature coupling improvements

### Could Have
- [ ] Build Templates feature
- [ ] Weekly Boss Tracker
- [ ] Embedded wfpsim binary (research/prototype)

---

## Resources

- [wfpsim GitHub](https://github.com/ancientdialogue/wfpsim) - Source code, releases
- [wfpsim.com](https://wfpsim.com/) - Web app (up to date with patch 6.2+)
- [gcsim Docs](https://docs.gcsim.app/) - Config format documentation
- [Building a Simulation Tutorial](https://docs.gcsim.app/guides/building_a_simulation_basic_tutorial/)
